@startuml Class_Diagram
title Class Diagram: Messenger Clone System

package "Database Models" {
  class User {
    -id: String
    -name: String
    -email: String
    -emailVerified: DateTime?
    -image: String?
    -hashedPassword: String?
    -createdAt: DateTime
    -updatedAt: DateTime
    -conversationIds: String[]
    -seenMessageIds: String[]
  }

  class Conversation {
    -id: String
    -createdAt: DateTime
    -lastMessageAt: DateTime
    -name: String?
    -isGroup: Boolean?
    -userIds: String[]
    -messagesSId: String[]
  }

  class Message {
    -id: String
    -body: String?
    -image: String?
    -fileUrl: String?
    -fileName: String?
    -fileSize: Int?
    -createdAt: DateTime
    -seenIds: String[]
    -conversationId: String
    -senderId: String
    -isDeleted: Boolean
    -replyToId: String?
  }

  class Reaction {
    -id: String
    -content: String
    -createdAt: DateTime
    -userId: String
    -messageId: String
  }

  class Account {
    -id: String
    -userId: String
    -type: String
    -provider: String
    -providerAccountId: String
    -refresh_token: String?
    -access_token: String?
    -expires_at: Int?
    -token_type: String?
    -scope: String?
    -id_token: String?
    -session_state: String?
  }

  class AiMemory {
    -id: String
    -userId: String
    -content: String
    -createdAt: DateTime
  }

  class AiKnowledge {
    -id: String
    -topic: String
    -content: String
    -createdAt: DateTime
  }
}

package "Services" {
  class AIService {
    +buildSystemPrompt(userId: string): Promise<string>
    +generateResponse(userId: string, userMessage: string): Promise<string>
    +processAutoMemory(userId: string, message: string): Promise<boolean>
  }

  class PrismaClient {
    +user.findUnique()
    +user.findMany()
    +user.create()
    +conversation.findUnique()
    +conversation.findMany()
    +conversation.create()
    +conversation.update()
    +conversation.deleteMany()
    +message.findUnique()
    +message.findMany()
    +message.create()
    +message.update()
    +aiMemory.findMany()
    +aiMemory.create()
    +aiKnowledge.findMany()
  }

  class PusherServer {
    +trigger(channel: string, event: string, data: any): Promise<void>
  }

  class PusherClient {
    +subscribe(channel: string): Channel
    +unsubscribe(channel: string): void
    +bind(event: string, callback: Function): void
    +unbind(event: string, callback: Function): void
  }
}

package "API Routes" {
  class AuthRoute {
    +POST /api/auth/[...nextauth]()
    +authorize(credentials): Promise<User | null>
  }

  class ConversationRoute {
    +POST /api/conversations(): createConversation()
    +DELETE /api/conversations/[id](): deleteConversation()
    +POST /api/conversations/[id]/seen(): markAsSeen()
  }

  class MessageRoute {
    +POST /api/messages(): createMessage()
    +DELETE /api/messages/[id](): deleteMessage()
    +POST /api/messages/[id]/react(): addReaction()
  }

  class GeminiRoute {
    +POST /api/gemini(): generateAIResponse()
  }

  class RegisterRoute {
    +POST /api/register(): registerUser()
  }
}

package "Server Actions" {
  class getCurrentUser {
    +getCurrentUser(): Promise<User | null>
  }

  class getConversation {
    +getConversations(): Promise<Conversation[]>
  }

  class getConversationById {
    +getConversationById(id: string): Promise<Conversation | null>
  }

  class getMessages {
    +getMessages(conversationId: string): Promise<Message[]>
  }

  class getUsers {
    +getUsers(): Promise<User[]>
  }

  class getSession {
    +getSession(): Promise<Session | null>
  }
}

package "Custom Hooks" {
  class useActiveChannel {
    +useActiveChannel(): void
  }

  class useActiveList {
    +add(id: string): void
    +remove(id: string): void
    +set(ids: string[]): void
  }

  class useConversation {
    +useConversation(): { conversationId: string, isOpen: boolean }
  }

  class useOtherUser {
    +useOtherUser(conversation: Conversation): User
  }
}

' Relationships
User "1" *-- "many" Conversation : participates in
User "1" *-- "many" Message : sends
User "1" *-- "many" Message : sees
User "1" *-- "many" Reaction : creates
User "1" *-- "many" Account : has
Conversation "1" *-- "many" Message : contains
Message "1" *-- "0..1" Message : replies to
Message "1" *-- "many" Reaction : has
User "1" *-- "many" AiMemory : has

' Service dependencies
AIService ..> PrismaClient : uses
AIService ..> AiMemory : reads
AIService ..> AiKnowledge : reads
ConversationRoute ..> PrismaClient : uses
ConversationRoute ..> PusherServer : uses
MessageRoute ..> PrismaClient : uses
MessageRoute ..> PusherServer : uses
GeminiRoute ..> AIService : uses
GeminiRoute ..> PrismaClient : uses
GeminiRoute ..> PusherServer : uses
getCurrentUser ..> PrismaClient : uses
getConversation ..> PrismaClient : uses
getMessages ..> PrismaClient : uses
getUsers ..> PrismaClient : uses

@enduml

