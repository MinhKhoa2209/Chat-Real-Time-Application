@startuml Activity_Register_Login
title Activity Diagram: Register / Login

|User|
start
:Access login page;

|System|
:Receive login request;

|User|
:Select login method;

|System|
if (Login method?) then ([Email/Password])
  |User|
  :Enter email and password;
  :Click "Sign In";
  
  |System|
  :Validate credentials;
  :Check user in database;
  :Compare password hash;
  
  if (User exists and password correct?) then ([Yes])
    :Create JWT session;
    :Set session cookie;
    |User|
    :Redirect to home page;
    stop
  else ([No])
    :Display error: "Invalid credentials";
    |User|
    :See error message;
    stop
  endif
else ([OAuth - Google/GitHub])
  |User|
  :Click OAuth provider button;
  
  |System|
  :Redirect to OAuth provider;
  
  |OAuth Provider|
  :Display authorization page;
  |User|
  :Authorize access;
  
  |OAuth Provider|
  :Return access token;
  
  |System|
  :Validate token;
  if (Token valid?) then ([Yes])
    :Create or link account;
    :Create JWT session;
    :Set session cookie;
    |User|
    :Redirect to home page;
    stop
  else ([No])
    :Display error;
    |User|
    :See error message;
    stop
  endif
endif

@enduml

@startuml Activity_Create_Conversation
title Activity Diagram: Create Conversation (1-1 or Group)

|User|
start
:Click "Start Conversation" or "Create Group";

|System|
:Display conversation creation options;

|User|
:Select conversation type;

|System|
if (Conversation type?) then ([1-1 Conversation])
  |User|
  :Select a user from list;
  
  |System|
  :Check if conversation exists;
  if (Conversation already exists?) then ([Yes])
    :Return existing conversation;
    |User|
    :Navigate to conversation;
    stop
  else ([No])
    :Create new Conversation;
    :Connect both users;
    :Trigger Pusher event "conversation:new";
    |Pusher|
    :Broadcast to all participants;
    |User|
    :See conversation in list;
    stop
  endif
else ([Group Chat])
  |User|
  :Enter group name;
  :Select at least 2 members;
  :Click "Create";
  
  |System|
  :Validate input;
  if (Name empty or members < 2?) then ([Yes])
    :Disable "Create" button;
    :Display validation error;
    |User|
    :See error message;
    stop
  else ([No])
    :Create Conversation with isGroup=true;
    :Connect creator and all selected members;
    :Trigger Pusher event "conversation:new";
    |Pusher|
    :Broadcast to all members;
    |User|
    :See group chat in list;
    stop
  endif
endif

@enduml

@startuml Activity_Send_Message
title Activity Diagram: Send Message (Text/Image/File)

|User|
start
:Open conversation;

:Select message type and content;

|System|
if (Message type?) then ([Text])
  |User|
  :Type and send text message;
  
  |System|
  :Save message to database;
  :Trigger Pusher event;
  |Pusher|
  :Broadcast to all members;
  |User|
  :See message displayed;
  stop
elseif ([Image/File]) then
  |User|
  :Select and upload file/image;
  
  |System|
  :Process upload and get URL;
  
  if (Upload successful?) then ([Yes])
    :Save message with file/image URL;
    :Trigger Pusher event;
    |Pusher|
    :Broadcast to all members;
    |User|
    :See message displayed;
    stop
  else ([No])
    :Display error;
    |User|
    stop
  endif
endif

@enduml

@startuml Activity_Chat_AI
title Activity Diagram: Chat with AI Assistant (Gemini)

|User|
start
:Open AI conversation;
note right: Conversation with gemini@messenger.com

:Type message and send;

|System|
:Save user message to database;

:Call AIService.generateResponse();
note right: Passes userId and message

:Build system prompt;
note right: Includes user memory, knowledge base, current date/time

:Send request to Google Gemini API;

|Gemini API|
:Process query;

if (API call successful?) then ([Yes])
  :Generate response;
  |System|
  :Receive AI response text;
  :Save AI message to database;
  note right: senderId = AI_BOT_ID
  
  :Trigger Pusher event "messages:new";
  |Pusher|
  :Broadcast to user;
  |User|
  :See AI response in real-time;
  
  |System|
  :Process auto-memory (if applicable);
  note right: Checks if message contains introduction pattern
  
  stop
else ([No - API Error])
  |System|
  :Create error message;
  :Save error message: "Xin lỗi, hiện tại mình đang gặp chút trục trặc...";
  :Trigger Pusher event "messages:new";
  |Pusher|
  :Broadcast to user;
  |User|
  :See error message;
  stop
endif

@enduml

@startuml Activity_View_Conversation_List
title Activity Diagram: View Conversation List

|User|
start
:Log into system;

|System|
:Validate user session;

if (User authenticated?) then ([No])
  :Redirect to login;
  |User|
  stop
else ([Yes])
  :Load conversation list from database;
  :Subscribe to Pusher channel;
  
  |User|
  :See conversation list in sidebar;
  
  |System|
  :Listen for real-time updates;
  
  |Pusher|
  :Broadcast conversation events;
  
  |System|
  :Update conversation list;
  
  |User|
  :See list updated;
  
  stop
endif

@enduml

@startuml Activity_Mark_Seen
title Activity Diagram: Mark Message as Seen (Read Receipt)

|User|
start
:Open conversation;

|System|
:UI component (Body) mounts;

:Call POST /api/conversations/[id]/seen;

:Validate user authentication;

:Find conversation and last message;

if (Last message exists?) then ([No])
  :Return conversation;
  |User|
  stop
else ([Yes])
  :Check if user already in seen list;
  
  if (User already seen?) then ([Yes])
    :Return conversation;
    |User|
    stop
  else ([No])
    :Update message: connect user to seen list;
    :Trigger Pusher event to user's email channel;
    :Trigger Pusher event to conversation channel;
    |Pusher|
    :Broadcast to all members;
    |User|
    :See updated read receipt;
    stop
  endif
endif

@enduml
